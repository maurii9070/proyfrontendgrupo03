<div class="container-fluid main-admin-container">
  <div class="row flex-nowrap">
    <!-- Aside -->
    <aside
      class="col-12 col-md-3 col-lg-2 px-0 bg-light shadow-sm min-vh-100 d-flex flex-column admin-aside"
    >
      <div class="p-3 border-bottom">
        <h5 class="fw-bold mb-0 text-primary">Panel Admin</h5>
      </div>
      <nav class="nav flex-column p-3 gap-2">
        <button
          class="btn btn-outline-primary w-100"
          [class.active]="section === 'turnos'"
          (click)="section = 'turnos'"
        >
          <i class="bi bi-calendar-check"></i> Turnos a confirmar
        </button>
        <button
          class="btn btn-outline-primary w-100"
          [class.active]="section === 'pacientes'"
          (click)="section = 'pacientes'"
        >
          <i class="bi bi-people"></i> Pacientes
        </button>
        <button
          class="btn btn-outline-primary w-100"
          [class.active]="section === 'doctores'"
          (click)="section = 'doctores'"
        >
          <i class="bi bi-person-badge"></i> Doctores
        </button>
        <button
          class="btn btn-outline-info w-100"
          [class.active]="section === 'todos-turnos'"
          (click)="section = 'todos-turnos'"
        >
          <i class="bi bi-list-check"></i> Todos los turnos
        </button>
        <button
          class="btn btn-outline-success w-100"
          [class.active]="section === 'registrar-doctor'"
          (click)="onClickRegistrarDoctor()"
        >
          <i class="bi bi-person-plus"></i> Registrar Doctor
        </button>
        <button
          class="btn btn-outline-info w-100"
          [class.active]="section === 'estadisticas'"
          (click)="onClickEstadisticas()"
        >
          <i class="bi bi-graph-up"></i> Estadísticas
        </button>
      </nav>
      <div class="mt-auto p-3 small text-muted">&copy; 2025 Admin</div>
    </aside>

    <!-- Main Content -->
    <main class="col px-0 py-4 px-md-4">
      <!-- Todos los Turnos -->
      @if (section==='todos-turnos') {
      <h3 class="mb-4 fw-bold text-primary">Todos los turnos</h3>
      <div
        class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 gap-2"
      >
        <form class="d-flex gap-2 flex-wrap" (submit)="$event.preventDefault()">
          <input
            type="date"
            class="form-control"
            [(ngModel)]="filtroFecha"
            name="filtroFecha"
          />
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por DNI paciente"
            [(ngModel)]="filtroDni"
            name="filtroDni"
          />
          <button
            class="btn btn-outline-primary"
            type="button"
            (click)="filtrarTurnos()"
          >
            Filtrar
          </button>
          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="limpiarFiltros()"
          >
            Limpiar
          </button>
        </form>
      </div>
      <div class="table-responsive rounded shadow-sm">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Paciente</th>
              <th>DNI</th>
              <th>Doctor</th>
              <th>Fecha</th>
              <!-- <th>Comprobante</th> -->
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            @if (turnosFiltrados.length === 0) {
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <i class="bi bi-info-circle"></i> No hay turnos para mostrar.
              </td>
            </tr>
            } @else { @for (turno of turnosFiltrados; track turno) {
            <tr>
              <td>{{ turno.paciente.nombre }} {{ turno.paciente.apellido }}</td>
              <td>{{ turno.paciente.dni }}</td>
              <td>{{ turno.doctor.nombre }} {{ turno.doctor.apellido }}</td>
              <td>{{ turno.fecha }}</td>
              <!-- <td>
                                @if (getArchivoPago(turno)) {
                                            <a [href]="getArchivoPago(turno).url" target="_blank" class="btn btn-sm btn-outline-info">
                                                Ver comprobante
                                            </a>
                                            <div class="small text-muted">ID: {{ getArchivoPago(turno)._id }}</div>
                                        } @else {
                                            <span class="text-muted">Sin comprobante</span>
                                        }
                            </td> -->
              <td>
                @if (turno.estado==='pendiente') {
                <span class="badge bg-warning text-dark">Pendiente</span>
                } @if (turno.estado==='confirmado') {
                <span class="badge bg-success">Confirmado</span>
                } @if (turno.estado==='realizado') {
                <span class="badge bg-success">Confirmado</span>
                } @if (turno.estado==='cancelado') {
                <span class="badge bg-danger">Cancelado</span>
                }
              </td>
            </tr>
            } }
          </tbody>
        </table>
      </div>
      }
      <!-- Turnos a confirmar -->
      @if (section==='turnos') {
      <h3 class="mb-4 fw-bold text-primary">Turnos a confirmar pago</h3>
      <div class="table-responsive rounded shadow-sm">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Paciente</th>
              <th>Doctor</th>
              <th>Fecha</th>
              <th>Comprobante</th>
              <th>Estado</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            @if (turnos.length === 0) {
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <i class="bi bi-info-circle"></i> No hay turnos pendientes de
                pago.
              </td>
            </tr>
            } @else { @for (turno of turnos; track turno) {
            <tr>
              <td>{{ turno.paciente.nombre }} {{ turno.paciente.apellido }}</td>
              <td>{{ turno.doctor.nombre }} {{ turno.doctor.apellido }}</td>
              <td>{{ turno.fecha }}</td>
              <td>
                @if (getArchivoPago(turno); as archivoPago) {
                <a
                  [href]="archivoPago.url"
                  target="_blank"
                  class="btn btn-sm btn-primary"
                >
                  Ver comprobante
                </a>
                <div class="small text-muted">ID: {{ archivoPago._id }}</div>
                } @else {
                <span class="text-secondary">Sin comprobante</span>
                }
              </td>
              <td>
                @if (turno.estado==='pendiente') {
                <span class="badge bg-warning text-dark">Pendiente</span>
                } @if (turno.estado==='confirmado') {
                <span class="badge bg-success">Confirmado</span>
                } @if (turno.estado==='realizado') {
                <span class="badge bg-success">Confirmado</span>
                } @if (turno.estado==='cancelado') {
                <span class="badge bg-danger">Cancelado</span>
                }
              </td>
              <td>
                <button
                  class="btn btn-sm btn-success me-2"
                  [disabled]="turno.estado !== 'pendiente'"
                  (click)="onclickConfirmar(turno._id)"
                >
                  Confirmar Pago
                </button>
              </td>
              <!-- Modal de confirmación de pago -->
              <div
                class="modal fade show"
                tabindex="-1"
                [ngStyle]="{
                  display: showConfirmPagoModal ? 'block' : 'none',
                  background: showConfirmPagoModal ? 'rgba(0,0,0,0.5)' : 'none'
                }"
                *ngIf="showConfirmPagoModal"
              >
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title text-success">
                        <i class="bi bi-check-circle-fill"></i> Pago confirmado
                      </h5>
                      <button
                        type="button"
                        class="btn-close"
                        aria-label="Close"
                        (click)="showConfirmPagoModal = false"
                      ></button>
                    </div>
                    <div class="modal-body">
                      <p>El pago del turno ha sido confirmado con éxito.</p>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-success"
                        (click)="showConfirmPagoModal = false"
                      >
                        Aceptar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </tr>
            } }
          </tbody>
        </table>
      </div>
      }

      <!-- Pacientes -->
      @if (section==='pacientes') {
      <div
        class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 gap-2"
      >
        <h3 class="fw-bold text-primary mb-0">Pacientes</h3>
        <form class="d-flex gap-2" (submit)="$event.preventDefault()">
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por DNI"
            [(ngModel)]="dniBusqueda"
            name="dniBusqueda"
          />
          <button class="btn btn-outline-primary" type="button">Buscar</button>
        </form>
      </div>
      <div class="table-responsive rounded shadow-sm">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>DNI</th>
              <th>Email</th>
              <th>Teléfono</th>
            </tr>
          </thead>
          <tbody>
            @for (paciente of pacientes; track paciente) {
            <tr>
              <td>{{ paciente.nombre }}</td>
              <td>{{ paciente.dni }}</td>
              <td>{{ paciente.email }}</td>
              <td>{{ paciente.telefono }}</td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }

      <!-- Doctores -->
      @if (section==='doctores') {
      <h3 class="mb-4 fw-bold text-primary">Doctores</h3>
      <div class="table-responsive rounded shadow-sm">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Especialidad</th>
              <th>Teléfono</th>
              <th>Estado</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            @for (doctor of doctores; track doctor._id) {
            <tr>
              <td>{{ doctor.nombre }} {{ doctor.apellido }}</td>
              <td>{{ doctor.especialidad.nombre }}</td>
              <td>{{ doctor.telefono }}</td>
              <td>
                @if (doctor.activo === true) {
                <span class="badge bg-success">Activo</span>
                } @else {
                <span class="badge bg-secondary">Inactivo</span>
                }
              </td>

              <td>
                <button
                  class="btn btn-sm btn-outline-danger"
                  (click)="openEliminarDoctorModal(doctor)"
                >
                  Eliminar
                </button>
              </td>
              <!-- Modal de confirmación de eliminación de doctor -->
              <div
                class="modal fade show"
                tabindex="-1"
                [ngStyle]="{
                  display: showEliminarDoctorModal ? 'block' : 'none',
                  background: showEliminarDoctorModal
                    ? 'rgba(0,0,0,0.5)'
                    : 'none'
                }"
                *ngIf="showEliminarDoctorModal"
              >
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title text-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Confirmar eliminación
                      </h5>
                      <button
                        type="button"
                        class="btn-close"
                        aria-label="Close"
                        (click)="showEliminarDoctorModal = false"
                      ></button>
                    </div>
                    <div class="modal-body">
                      <p>
                        ¿Estás seguro que deseas eliminar al doctor
                        <b
                          >{{ doctorAEliminar?.nombre }}
                          {{ doctorAEliminar?.apellido }}</b
                        >?
                      </p>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        (click)="showEliminarDoctorModal = false"
                      >
                        Cancelar
                      </button>
                      <button
                        type="button"
                        class="btn btn-danger"
                        (click)="confirmarEliminarDoctor()"
                      >
                        Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </main>
  </div>
</div>
